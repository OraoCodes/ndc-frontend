######################################################################
# Apache virtual host config for the NDC-frontend project
#
# Usage:
# 1. Copy this file to your VPS: /etc/apache2/sites-available/ndc.conf
# 2. Replace `example.com` with your domain name and update paths if needed.
# 3. Enable required Apache modules and the site, then reload Apache:
#    sudo a2enmod proxy proxy_http headers rewrite ssl
#    sudo cp deploy/apache-ndc.conf /etc/apache2/sites-available/ndc.conf
#    sudo a2ensite ndc.conf
#    sudo systemctl reload apache2
#
# This configuration reverse-proxies both the SPA and API to the Node
# process listening on localhost:3000 (production server started by
# `npm start`). In development the app runs under Vite (default port 8080)
# so point DNS or test using curl to the dev port as needed.
######################################################################

<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com

    # Recommended security headers (adjust as needed)
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Preserve original host and forward protocol
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}

    # Proxy /api requests to the Node API server
    ProxyPass "/api/" "http://127.0.0.1:3000/api/"
    ProxyPassReverse "/api/" "http://127.0.0.1:3000/api/"

    # Everything else -> proxy to Node (server serves built SPA or static files)
    ProxyPass "/" "http://127.0.0.1:3000/"
    ProxyPassReverse "/" "http://127.0.0.1:3000/"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ndc_error.log
    CustomLog ${APACHE_LOG_DIR}/ndc_access.log combined

    # Optional: increase proxy timeout for larger downloads/uploads
    ProxyTimeout 300

</VirtualHost>

## Optional HTTPS configuration (replace cert paths and enable port 443):
##
## <IfModule mod_ssl.c>
## <VirtualHost *:443>
##   ServerName example.com
##   ServerAlias www.example.com
##   SSLEngine on
##   SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
##   SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem
##
##   ProxyPreserveHost On
##   RequestHeader set X-Forwarded-Proto "https"
##   ProxyPass "/api/" "http://127.0.0.1:3000/api/"
##   ProxyPassReverse "/api/" "http://127.0.0.1:3000/api/"
##   ProxyPass "/" "http://127.0.0.1:3000/"
##   ProxyPassReverse "/" "http://127.0.0.1:3000/"
##
##   ErrorLog ${APACHE_LOG_DIR}/ndc_ssl_error.log
##   CustomLog ${APACHE_LOG_DIR}/ndc_ssl_access.log combined
## </VirtualHost>
## </IfModule>

######################################################################
## Notes
## - If you prefer to let Apache serve static files directly (instead of proxying
##   to Node), change the root to the `dist/spa` build output and remove the
##   trailing ProxyPass for "/". Example:
##     DocumentRoot /var/www/ndc/dist/spa
##     <Directory /var/www/ndc/dist/spa>
##       Require all granted
##     </Directory>
##   Then proxy only `/api/` to Node.
## - For large file uploads consider using a dedicated file store and/or
##   configure the Node server to accept streamed multipart uploads.
######################################################################

## ------------------------------------------------------------------
## DocumentRoot Variant (serve built SPA files directly, proxy only /api)
## ------------------------------------------------------------------
## Copy this block to /etc/apache2/sites-available/ndc-spa.conf and edit
## paths/domain names before enabling. This configuration serves the
## pre-built SPA from `dist/spa` and forwards only API requests to Node.
## Make sure you run `npm run build` (or `pnpm build`) and copy the
## `dist/spa` output to the server path below.
##
## Example usage:
##   sudo cp deploy/apache-ndc.conf /etc/apache2/sites-available/ndc-spa.conf
##   sudo a2ensite ndc-spa.conf
##   sudo systemctl reload apache2
##
## Replace `/var/www/ndc/dist/spa` with the path where your SPA files live.
##
## Note: this variant improves performance for static assets and lets Apache
## handle caching, TLS termination, and range requests for downloads.
##
## <VirtualHost *:80>
##     ServerName example.com
##     ServerAlias www.example.com
##
##     # Document root for the built SPA
##     DocumentRoot /var/www/ndc/dist/spa
##
##     <Directory /var/www/ndc/dist/spa>
##       Options -Indexes +FollowSymLinks
##       AllowOverride None
##       Require all granted
##     </Directory>
##
##     # Security headers
##     Header always set X-Frame-Options "DENY"
##     Header always set X-Content-Type-Options "nosniff"
##     Header always set Referrer-Policy "no-referrer-when-downgrade"
##
##     # Proxy only API requests to Node server
##     ProxyPreserveHost On
##     RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}
##     ProxyPass "/api/" "http://127.0.0.1:3000/api/"
##     ProxyPassReverse "/api/" "http://127.0.0.1:3000/api/"
##
##     # SPA fallback: serve index.html for non-file requests (client routing)
##     RewriteEngine On
##     # If the request is for a file that exists, serve it directly
##     RewriteCond %{REQUEST_FILENAME} -f
##     RewriteRule .* - [L]
##     # Otherwise rewrite to index.html so the SPA can handle routing
##     RewriteRule ^ /index.html [L]
##
##     # Logging
##     ErrorLog ${APACHE_LOG_DIR}/ndc_spa_error.log
##     CustomLog ${APACHE_LOG_DIR}/ndc_spa_access.log combined
##
##     # Optional caching for static assets
##     <IfModule mod_expires.c>
##       ExpiresActive On
##       ExpiresByType text/html "access plus 1 hour"
##       ExpiresByType text/css "access plus 7 days"
##       ExpiresByType application/javascript "access plus 7 days"
##       ExpiresByType image/* "access plus 30 days"
##     </IfModule>
## </VirtualHost>

